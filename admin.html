<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ - ×©×™×¨×•×ª×™+</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/admin.css">
    <style>
        /* Base styles */
        body, html {
            font-family: 'Heebo', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
            direction: rtl;
        }
        
        /* Container */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .admin-logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color, #01b3a7);
        }

        .admin-user-info {
            display: flex;
            align-items: center;
        }
        
        .admin-user-info-text {
            margin-left: 10px;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Main area with sidebar */
        .admin-main {
            display: flex;
            gap: 20px;
            flex: 1;
        }
        
        .admin-sidebar {
            width: 200px;
            flex-shrink: 0;
        }
        
        .admin-content {
            flex: 1;
        }
        
        /* Navigation */
        .admin-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .admin-nav button {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-align: right;
        }
        
        .admin-nav button.active {
            background-color: var(--primary-color, #01b3a7);
            color: white;
        }

        /* Section styles */
        .admin-section {
            display: none;
            margin-bottom: 20px;
        }
        
        .admin-section.active {
            display: block;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .section-controls {
            display: flex;
            gap: 10px;
        }

        /* Loading overlay */
        .loading-overlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color, #01b3a7);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error container */
        .error-container {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .error-container.hidden {
            display: none;
        }
        
        /* Buttons */
        button {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .add-button, .primary-button, .save-button {
            background-color: var(--primary-color, #01b3a7);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-weight: bold;
        }
        
        .cancel-button {
            background-color: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
        }
        
        /* Items list */
        .list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .item-card {
            background-color: white;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .item-actions {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
        }
        
        .action-button {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .action-button:hover {
            opacity: 1;
        }
        
        .item-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            margin-left: 60px; /* Space for actions */
        }
        
        .item-details {
            font-size: 14px;
            color: #555;
        }
        
        .item-details > div {
            margin-bottom: 5px;
        }
        
        /* Search container */
        .search-container {
            position: relative;
            margin-bottom: 10px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        
        .search-results-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 6px;
            width: 450px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .close-modal {
            font-size: 24px;
            color: #777;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-error {
            color: #d9534f;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-primary {
            background-color: var(--primary-color, #01b3a7);
            color: white;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .text-danger {
            color: #d9534f;
        }
        
        .text-success {
            color: #4caf50;
        }
        
        .interest-areas-section {
            margin-top: 20px;
        }
        
        .interest-areas-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .empty-message {
            color: #777;
            padding: 20px;
            text-align: center;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .error-message {
            color: #d9534f;
            padding: 20px;
            text-align: center;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        /* System Messages */
        .admin-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 10px 20px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            transition: transform 0.3s ease-in-out;
        }
        
        .admin-message.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .admin-message.success {
            background-color: #4caf50;
        }
        
        .admin-message.error {
            background-color: #f44336;
        }
        
        .admin-message.info {
            background-color: var(--primary-color, #01b3a7);
        }
        
        /* Refresh Button */
        .refresh-button {
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .refresh-button::before {
            content: 'ğŸ”„';
        }

        /* Header titles */
        .header-title {
            color: var(--primary-color, #01b3a7);
            font-size: 20px;
            margin-bottom: 15px;
        }

        .results-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .section-actions {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <div id="error-container" class="error-container hidden">
        <div id="error-message"></div>
    </div>
    
    <div class="admin-container" style="display: none;">
        <header class="admin-header">
            <div class="admin-logo">×¤×× ×œ × ×™×”×•×œ - ×©×™×¨×•×ª×™+</div>
            <div class="admin-user-info">
                <div id="user-info" class="admin-user-info-text"></div>
                <div class="admin-actions">
                    <button class="refresh-button" id="refresh-data-button">×¨×¢× ×Ÿ × ×ª×•× ×™×</button>
                    <button id="logout-button" class="btn btn-secondary">×”×ª× ×ª×§</button>
                </div>
            </div>
        </header>
        
        <main class="admin-main">
            <div class="admin-sidebar">
                <nav class="admin-nav">
                    <button class="nav-button active" data-section="services-section">×©×™×¨×•×ª×™×</button>
                    <button class="nav-button" data-section="categories-section">×§×˜×’×•×¨×™×•×ª</button>
                    <button class="nav-button" data-section="interest-areas-section">×ª×—×•××™ ×¢× ×™×™×Ÿ</button>
                    <button class="nav-button" data-section="users-section">××©×ª××©×™×</button>
                </nav>
            </div>
            
            <div class="admin-content">
                <div id="services-section" class="admin-section active">
                    <div class="header-container">
                        <h2 class="header-title">× ×™×”×•×œ ×©×™×¨×•×ª×™×</h2>
                        <div class="search-container">
                            <input type="text" id="services-search" class="search-input" placeholder="×—×™×¤×•×© ×©×™×¨×•×ª×™×...">
                        </div>
                    </div>
                    <div class="results-info" id="services-results-info"></div>
                    <div class="section-actions">
                        <button id="add-service" class="primary-button">×”×•×¡×£ ×©×™×¨×•×ª ×—×“×©</button>
                    </div>
                    <div id="services-list" class="list-container">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div id="categories-section" class="admin-section">
                    <div class="header-container">
                        <h2 class="header-title">× ×™×”×•×œ ×§×˜×’×•×¨×™×•×ª</h2>
                        <div class="search-container">
                            <input type="text" id="categories-search" class="search-input" placeholder="×—×™×¤×•×© ×§×˜×’×•×¨×™×•×ª...">
                        </div>
                    </div>
                    <div class="results-info" id="categories-results-info"></div>
                    <div class="section-actions">
                        <button id="add-category" class="primary-button">×”×•×¡×£ ×§×˜×’×•×¨×™×” ×—×“×©×”</button>
                    </div>
                    <div id="categories-list" class="list-container">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div id="interest-areas-section" class="admin-section">
                    <div class="header-container">
                        <h2 class="header-title">× ×™×”×•×œ ×ª×—×•××™ ×¢× ×™×™×Ÿ</h2>
                        <div class="search-container">
                            <input type="text" id="interest-areas-search" class="search-input" placeholder="×—×™×¤×•×© ×ª×—×•××™ ×¢× ×™×™×Ÿ...">
                        </div>
                    </div>
                    <div class="results-info" id="interest-areas-results-info"></div>
                    <div class="section-actions">
                        <button id="add-interest-area" class="primary-button">×”×•×¡×£ ×ª×—×•× ×¢× ×™×™×Ÿ ×—×“×©</button>
                    </div>
                    <div id="interest-areas-list" class="list-container">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div id="users-section" class="admin-section">
                    <div class="header-container">
                        <h2 class="header-title">× ×™×”×•×œ ××©×ª××©×™×</h2>
                        <div class="search-container">
                            <input type="text" id="users-search" class="search-input" placeholder="×—×™×¤×•×© ××©×ª××©×™×...">
                        </div>
                    </div>
                    <div class="results-info" id="users-results-info"></div>
                    <div id="users-list" class="list-container">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Service Modal -->
    <div id="service-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="service-modal-title">×”×•×¡×¤×ª ×©×™×¨×•×ª ×—×“×©</h3>
                <button class="close-modal" id="close-service-modal">&times;</button>
            </div>
            <form id="service-form">
                <input type="hidden" id="service-id">
                <div class="form-group">
                    <label for="service-name" class="form-label">×©× ×”×©×™×¨×•×ª</label>
                    <input type="text" id="service-name" class="form-input" required>
                    <div class="error-text" id="service-name-error"></div>
                </div>
                <div class="form-group">
                    <label for="service-description" class="form-label">×ª×™××•×¨</label>
                    <textarea id="service-description" class="form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label for="service-category" class="form-label">×§×˜×’×•×¨×™×”</label>
                    <select id="service-category" class="form-select">
                        <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="service-interest-areas" class="form-label">×ª×—×•××™ ×¢× ×™×™×Ÿ</label>
                    <div id="service-interest-areas-container" style="margin-top: 8px;"></div>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-button" id="cancel-service">×‘×™×˜×•×œ</button>
                    <button type="submit" class="save-button">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="category-modal-title">×”×•×¡×¤×ª ×§×˜×’×•×¨×™×” ×—×“×©×”</h3>
                <button class="close-modal" id="close-category-modal">&times;</button>
            </div>
            <form id="category-form">
                <input type="hidden" id="category-id">
                <div class="form-group">
                    <label for="category-name" class="form-label">×©× ×”×§×˜×’×•×¨×™×”</label>
                    <input type="text" id="category-name" class="form-input" required>
                    <div class="error-text" id="category-name-error"></div>
                </div>
                <div class="form-group">
                    <label for="category-description" class="form-label">×ª×™××•×¨</label>
                    <textarea id="category-description" class="form-textarea"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-button" id="cancel-category">×‘×™×˜×•×œ</button>
                    <button type="submit" class="save-button">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Interest Area Modal -->
    <div id="interest-area-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="interest-area-modal-title">×”×•×¡×¤×ª ×ª×—×•× ×¢× ×™×™×Ÿ ×—×“×©</h3>
                <button class="close-modal" id="close-interest-area-modal">&times;</button>
            </div>
            <form id="interest-area-form">
                <input type="hidden" id="interest-area-id">
                <div class="form-group">
                    <label for="interest-area-name" class="form-label">×©× ×ª×—×•× ×”×¢× ×™×™×Ÿ</label>
                    <input type="text" id="interest-area-name" class="form-input" required>
                    <div class="error-text" id="interest-area-name-error"></div>
                </div>
                <div class="form-group">
                    <label for="interest-area-description" class="form-label">×ª×™××•×¨</label>
                    <textarea id="interest-area-description" class="form-textarea"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-button" id="cancel-interest-area">×‘×™×˜×•×œ</button>
                    <button type="submit" class="save-button">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="user-modal-title">×¢×¨×™×›×ª ××©×ª××©</h3>
                <button class="close-modal" id="close-user-modal">&times;</button>
            </div>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="form-group">
                    <label for="user-name" class="form-label">×©×</label>
                    <input type="text" id="user-name" class="form-input">
                </div>
                <div class="form-group">
                    <label for="user-email" class="form-label">××™××™×™×œ</label>
                    <input type="email" id="user-email" class="form-input" disabled>
                </div>
                <div class="form-group">
                    <label for="user-role" class="form-label">×ª×¤×§×™×“</label>
                    <select id="user-role" class="form-select">
                        <option value="user">××©×ª××©</option>
                        <option value="admin">×× ×”×œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">×¡×˜×˜×•×¡</label>
                    <div class="status-toggle">
                        <label class="switch">
                            <input type="checkbox" id="user-status">
                            <span class="slider"></span>
                        </label>
                        <span id="status-text">×¤×¢×™×œ</span>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-button" id="cancel-user">×‘×™×˜×•×œ</button>
                    <button type="submit" class="save-button">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Loading and error UI elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const adminContainer = document.querySelector('.admin-container');
        
        function showError(message) {
            loadingOverlay.style.display = 'none';
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }
        
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        function showAdmin() {
            loadingOverlay.style.display = 'none';
            errorContainer.classList.add('hidden');
            adminContainer.style.display = 'block';
        }
        
        // Initialize Firebase with config from server
        async function initializeFirebase() {
            try {
                const isDevelopment = window.location.hostname === 'localhost' || 
                                     window.location.hostname === '127.0.0.1';
                
                // Fetch Firebase config from server
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error('Failed to fetch Firebase configuration');
                }
                
                const firebaseConfig = await response.json();
                firebase.initializeApp(firebaseConfig);
                
                console.log('Firebase initialized with server config');
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showError('×©×’×™××” ×‘××ª×—×•×œ ××¢×¨×›×ª. × × ×œ× ×¡×•×ª ×©×•×‘.');
                return false;
            }
        }
        
        // Main initialization function
        async function init() {
            try {
                // Initialize Firebase first
                const initialized = await initializeFirebase();
                if (!initialized) return;
                
                // Set up auth state listener
                firebase.auth().onAuthStateChanged(async (user) => {
                    // Check if we're in development mode
                    const isDevelopment = window.location.hostname === 'localhost' || 
                                         window.location.hostname === '127.0.0.1';
                    
                    if (isDevelopment) {
                        console.log('Development mode detected in admin page');
                        hideLoading();
                        document.getElementById('user-info').textContent = '××¦×‘ ×¤×™×ª×•×— - ××©×ª××© ×‘×“×™×•× ×™';
                        showAdmin();
                        return;
                    }
                    
                    if (user) {
                        console.log('User is signed in:', user.uid);
                        
                        // Check if user is admin
                        const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                        
                        if (!userDoc.exists) {
                            console.log('User document does not exist');
                            showError('×—×©×‘×•×Ÿ ××©×ª××© ×œ× ×§×™×™× ×‘××¢×¨×›×ª. ×× × ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª.');
                            await firebase.auth().signOut();
                            return;
                        }
                        
                        const userData = userDoc.data();
                        if (userData.role !== 'admin') {
                            console.log('User is not an admin');
                            showError('××™×Ÿ ×œ×š ×”×¨×©××•×ª ×× ×”×œ ×‘××¢×¨×›×ª. ×× × ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª.');
                            await firebase.auth().signOut();
                            return;
                        }
                        
                        if (userData.status !== 'active') {
                            console.log('User is not active');
                            showError('×—×©×‘×•×Ÿ ×”×× ×”×œ ×©×œ×š ××™× ×• ×¤×¢×™×œ. ×× × ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª.');
                            await firebase.auth().signOut();
                            return;
                        }
                        
                        // User is an admin, show admin UI
                        document.getElementById('user-info').textContent = `×©×œ×•× ${user.displayName || userData.name || '×× ×”×œ'}`;
                        showAdmin();
                        
                        // Set up admin UI and load data
                        setupAdminUI();
                    } else {
                        console.log('No user signed in');
                        window.location.href = '/login';
                    }
                });
                
                // Set up logout button
                document.getElementById('logout-button').addEventListener('click', async () => {
                    try {
                        await firebase.auth().signOut();
                        window.location.href = '/login';
                    } catch (error) {
                        console.error('Logout error:', error);
                        alert('×©×’×™××” ×‘×”×ª× ×ª×§×•×ª. ×× × × ×¡×” ×©×•×‘.');
                    }
                });
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('×©×’×™××” ×‘××ª×—×•×œ ×”××¢×¨×›×ª. × × ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.');
            }
        }
        
        // Function to set up the admin UI
        function setupAdminUI() {
            // DOM elements for data storage
            let allServices = [];
            let allCategories = [];
            let allInterestAreas = [];
            let allUsers = [];
            
            // Cache constants
            const CACHE_EXPIRY = 5 * 60 * 1000; // 5 minutes
            const ADMIN_CACHE_PREFIX = 'admin_cache_';
            
            // References to UI elements
            const servicesListContainer = document.getElementById('services-list');
            const categoriesListContainer = document.getElementById('categories-list');
            const interestAreasListContainer = document.getElementById('interest-areas-list');
            const usersListContainer = document.getElementById('users-list');
            
            const servicesResultsInfo = document.getElementById('services-results-info');
            const categoriesResultsInfo = document.getElementById('categories-results-info');
            const interestAreasResultsInfo = document.getElementById('interest-areas-results-info');
            const usersResultsInfo = document.getElementById('users-results-info');
            
            const addServiceButton = document.getElementById('add-service');
            const addCategoryButton = document.getElementById('add-category');
            const addInterestAreaButton = document.getElementById('add-interest-area');
            
            // Cache functions
            function saveToCache(key, data) {
                try {
                    const cacheItem = {
                        data: data,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(ADMIN_CACHE_PREFIX + key, JSON.stringify(cacheItem));
                } catch (error) {
                    console.error('Error saving to cache:', error);
                }
            }
            
            function getFromCache(key) {
                try {
                    const cacheItemJson = localStorage.getItem(ADMIN_CACHE_PREFIX + key);
                    if (!cacheItemJson) return null;
                    
                    const cacheItem = JSON.parse(cacheItemJson);
                    if (!cacheItem || !cacheItem.timestamp) return null;
                    
                    if (Date.now() - cacheItem.timestamp > CACHE_EXPIRY) {
                        localStorage.removeItem(ADMIN_CACHE_PREFIX + key);
                        return null;
                    }
                    
                    return cacheItem.data;
                } catch (error) {
                    console.error('Error retrieving from cache:', error);
                    return null;
                }
            }
            
            function clearCache() {
                try {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(ADMIN_CACHE_PREFIX)) {
                            localStorage.removeItem(key);
                        }
                    });
                } catch (error) {
                    console.error('Error clearing cache:', error);
                }
            }
            
            // Helper functions
            function formatDate(timestamp) {
                if (!timestamp) return '×œ× ×™×“×•×¢';
                
                try {
                    let date;
                    if (timestamp.toDate) {
                        // Firestore Timestamp
                        date = timestamp.toDate();
                    } else if (typeof timestamp === 'string') {
                        // ISO String or other date string
                        date = new Date(timestamp);
                        // Check if valid date
                        if (isNaN(date.getTime())) {
                            return '×ª××¨×™×š ×œ× ×ª×§×™×Ÿ';
                        }
                    } else if (timestamp instanceof Date) {
                        // JavaScript Date object
                        date = timestamp;
                    } else {
                        // Unknown format
                        return '×ª××¨×™×š ×œ× ×ª×§×™×Ÿ';
                    }
                    
                    return new Intl.DateTimeFormat('he-IL', {
                        year: 'numeric',
                        month: 'numeric',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric'
                    }).format(date);
                } catch (error) {
                    console.error('Error formatting date:', error, timestamp);
                    return '×ª××¨×™×š ×œ× ×ª×§×™×Ÿ';
                }
            }
            
            function showMessage(message, type) {
                const messageElement = document.createElement('div');
                messageElement.className = `admin-message ${type}`;
                messageElement.textContent = message;
                document.body.appendChild(messageElement);
                
                setTimeout(() => {
                    messageElement.classList.add('show');
                }, 10);
                
                setTimeout(() => {
                    messageElement.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(messageElement);
                    }, 300);
                }, 3000);
            }
            
            // Data loading functions
            async function loadServices() {
                try {
                    servicesListContainer.innerHTML = '<div class="spinner"></div>';
                    
                    const db = firebase.firestore();
                    
                    // Check cache first
                    const cachedServices = getFromCache('services');
                    if (cachedServices) {
                        console.log('Using cached services data');
                        allServices = cachedServices;
                        renderServices(allServices);
                        servicesResultsInfo.textContent = `${allServices.length} ×©×™×¨×•×ª×™×`;
                        return;
                    }
                    
                    // Load from Firestore
                    const querySnapshot = await db.collection('services').orderBy('name').get();
                    
                    if (querySnapshot.empty) {
                        servicesListContainer.innerHTML = '<div class="empty-message">××™×Ÿ ×©×™×¨×•×ª×™× ×‘×¨×©×™××”.</div>';
                        servicesResultsInfo.textContent = '0 ×©×™×¨×•×ª×™×';
                        allServices = [];
                        return;
                    }
                    
                    allServices = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log(`×©×™×¨×•×ª×™× ×©× ×˜×¢× ×•: ${allServices.length}`);
                    
                    // Save to cache
                    saveToCache('services', allServices);
                    
                    renderServices(allServices);
                    servicesResultsInfo.textContent = `${allServices.length} ×©×™×¨×•×ª×™×`;
                    
                } catch (error) {
                    console.error('Error loading services:', error);
                    servicesListContainer.innerHTML = '<div class="error-message">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×©×™×¨×•×ª×™×. ×× × × ×¡×” ×©×•×‘.</div>';
                    servicesResultsInfo.textContent = '';
                }
            }
            
            function renderServices(services) {
                if (!services || services.length === 0) {
                    servicesListContainer.innerHTML = '<div class="empty-message">××™×Ÿ ×©×™×¨×•×ª×™× ×‘×¨×©×™××” ××• ×œ× × ××¦××• ×ª×•×¦××•×ª ×œ×—×™×¤×•×© ×©×œ×š.</div>';
                    return;
                }
                
                let html = '';
                services.forEach((service) => {
                    try {
                        let categoryName = '×œ× ××•×’×“×¨';
                        
                        if (service.categoryId && allCategories && allCategories.length > 0) {
                            const category = allCategories.find(c => c.id === service.categoryId);
                            if (category) {
                                categoryName = category.name;
                            }
                        }
                        
                        html += `
                            <div class="item-card" data-id="${service.id}">
                                <div class="item-actions">
                                    <button class="action-button edit-button" data-id="${service.id}" title="×¢×¨×•×š">âœï¸</button>
                                    <button class="action-button delete-button" data-id="${service.id}" title="××—×§">ğŸ—‘ï¸</button>
                                </div>
                                <div class="item-title">${service.name || '×œ×œ× ×©×'}</div>
                                <div class="item-details">
                                    <div>${service.description || '××™×Ÿ ×ª×™××•×¨'}</div>
                                    <div>×§×˜×’×•×¨×™×”: ${categoryName}</div>
                                    <div>×¢×•×“×›×Ÿ: ${formatDate(service.updatedAt)}</div>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        console.error('Error rendering service:', error, service);
                        html += `
                            <div class="item-card" data-id="${service.id}">
                                <div class="item-title">${service.name || '×©×™×¨×•×ª #' + service.id}</div>
                                <div class="item-details">
                                    <div class="error-message">×©×’×™××” ×‘×”×¦×’×ª ×”×©×™×¨×•×ª</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                servicesListContainer.innerHTML = html;
            }
            
            async function loadCategories() {
                try {
                    categoriesListContainer.innerHTML = '<div class="spinner"></div>';
                    
                    const db = firebase.firestore();
                    
                    // Check cache first
                    const cachedCategories = getFromCache('categories');
                    if (cachedCategories) {
                        console.log('Using cached categories data');
                        allCategories = cachedCategories;
                        renderCategories(allCategories);
                        categoriesResultsInfo.textContent = `${allCategories.length} ×§×˜×’×•×¨×™×•×ª`;
                        return;
                    }
                    
                    // Load from Firestore
                    const querySnapshot = await db.collection('categories').orderBy('name').get();
                    
                    if (querySnapshot.empty) {
                        categoriesListContainer.innerHTML = '<div class="empty-message">××™×Ÿ ×§×˜×’×•×¨×™×•×ª ×‘×¨×©×™××”.</div>';
                        categoriesResultsInfo.textContent = '0 ×§×˜×’×•×¨×™×•×ª';
                        allCategories = [];
                        return;
                    }
                    
                    allCategories = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log(`×§×˜×’×•×¨×™×•×ª ×©× ×˜×¢× ×•: ${allCategories.length}`);
                    
                    // Save to cache
                    saveToCache('categories', allCategories);
                    
                    renderCategories(allCategories);
                    categoriesResultsInfo.textContent = `${allCategories.length} ×§×˜×’×•×¨×™×•×ª`;
                    
                } catch (error) {
                    console.error('Error loading categories:', error);
                    categoriesListContainer.innerHTML = '<div class="error-message">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×˜×’×•×¨×™×•×ª. ×× × × ×¡×” ×©×•×‘.</div>';
                    categoriesResultsInfo.textContent = '';
                }
            }
            
            function renderCategories(categories) {
                if (!categories || categories.length === 0) {
                    categoriesListContainer.innerHTML = '<div class="empty-message">××™×Ÿ ×§×˜×’×•×¨×™×•×ª ×‘×¨×©×™××” ××• ×œ× × ××¦××• ×ª×•×¦××•×ª ×œ×—×™×¤×•×© ×©×œ×š.</div>';
                    return;
                }
                
                let html = '';
                categories.forEach((category) => {
                    html += `
                        <div class="item-card" data-id="${category.id}">
                            <div class="item-actions">
                                <button class="action-button edit-button" data-id="${category.id}" title="×¢×¨×•×š">âœï¸</button>
                                <button class="action-button delete-button" data-id="${category.id}" title="××—×§">ğŸ—‘ï¸</button>
                            </div>
                            <div class="item-title">${category.name}</div>
                            <div class="item-details">
                                <div>${category.description || '××™×Ÿ ×ª×™××•×¨'}</div>
                                <div>×¢×•×“×›×Ÿ: ${formatDate(category.updatedAt)}</div>
                            </div>
                        </div>
                    `;
                });
                
                categoriesListContainer.innerHTML = html;
            }
            
            async function loadInterestAreas() {
                try {
                    interestAreasListContainer.innerHTML = '<div class="spinner"></div>';
                    
                    const db = firebase.firestore();
                    
                    // Check cache first
                    const cachedInterestAreas = getFromCache('interestAreas');
                    if (cachedInterestAreas) {
                        console.log('Using cached interest areas data');
                        allInterestAreas = cachedInterestAreas;
                        renderInterestAreas(allInterestAreas);
                        interestAreasResultsInfo.textContent = `${allInterestAreas.length} ×ª×—×•××™ ×¢× ×™×™×Ÿ`;
                        return;
                    }
                    
                    // Load from Firestore
                    const querySnapshot = await db.collection('interest-areas').orderBy('name').get();
                    
                    if (querySnapshot.empty) {
                        interestAreasListContainer.innerHTML = '<div class="empty-message">××™×Ÿ ×ª×—×•××™ ×¢× ×™×™×Ÿ ×‘×¨×©×™××”.</div>';
                        interestAreasResultsInfo.textContent = '0 ×ª×—×•××™ ×¢× ×™×™×Ÿ';
                        allInterestAreas = [];
                        return;
                    }
                    
                    allInterestAreas = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log(`×ª×—×•××™ ×¢× ×™×™×Ÿ ×©× ×˜×¢× ×•: ${allInterestAreas.length}`);
                    
                    // Save to cache
                    saveToCache('interestAreas', allInterestAreas);
                    
                    renderInterestAreas(allInterestAreas);
                    interestAreasResultsInfo.textContent = `${allInterestAreas.length} ×ª×—×•××™ ×¢× ×™×™×Ÿ`;
                    
                } catch (error) {
                    console.error('Error loading interest areas:', error);
                    interestAreasListContainer.innerHTML = '<div class="error-message">×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×—×•××™ ×”×¢× ×™×™×Ÿ. ×× × × ×¡×” ×©×•×‘.</div>';
                    interestAreasResultsInfo.textContent = '';
                }
            }
            
            function renderInterestAreas(interestAreas) {
                if (!interestAreas || interestAreas.length === 0) {
                    interestAreasListContainer.innerHTML = '<div class="empty-message">××™×Ÿ ×ª×—×•××™ ×¢× ×™×™×Ÿ ×‘×¨×©×™××” ××• ×œ× × ××¦××• ×ª×•×¦××•×ª ×œ×—×™×¤×•×© ×©×œ×š.</div>';
                    return;
                }
                
                let html = '';
                interestAreas.forEach((interestArea) => {
                    html += `
                        <div class="item-card" data-id="${interestArea.id}">
                            <div class="item-actions">
                                <button class="action-button edit-button" data-id="${interestArea.id}" title="×¢×¨×•×š">âœï¸</button>
                                <button class="action-button delete-button" data-id="${interestArea.id}" title="××—×§">ğŸ—‘ï¸</button>
                            </div>
                            <div class="item-title">${interestArea.name}</div>
                            <div class="item-details">
                                <div>${interestArea.description || '××™×Ÿ ×ª×™××•×¨'}</div>
                                <div>×¢×•×“×›×Ÿ: ${formatDate(interestArea.updatedAt)}</div>
                            </div>
                        </div>
                    `;
                });
                
                interestAreasListContainer.innerHTML = html;
            }
            
            async function loadUsers() {
                try {
                    usersListContainer.innerHTML = '<div class="spinner"></div>';
                    
                    const db = firebase.firestore();
                    
                    // Check cache first
                    const cachedUsers = getFromCache('users');
                    if (cachedUsers) {
                        console.log('Using cached users data');
                        allUsers = cachedUsers;
                        renderUsers(allUsers);
                        usersResultsInfo.textContent = `${allUsers.length} ××©×ª××©×™×`;
                        return;
                    }
                    
                    // Load from Firestore
                    const querySnapshot = await db.collection('users').orderBy('email').get();
                    
                    if (querySnapshot.empty) {
                        usersListContainer.innerHTML = '<div class="empty-message">××™×Ÿ ××©×ª××©×™× ×‘×¨×©×™××”.</div>';
                        usersResultsInfo.textContent = '0 ××©×ª××©×™×';
                        allUsers = [];
                        return;
                    }
                    
                    allUsers = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log(`××©×ª××©×™× ×©× ×˜×¢× ×•: ${allUsers.length}`);
                    
                    // Save to cache
                    saveToCache('users', allUsers);
                    
                    renderUsers(allUsers);
                    usersResultsInfo.textContent = `${allUsers.length} ××©×ª××©×™×`;
                    
                } catch (error) {
                    console.error('Error loading users:', error);
                    usersListContainer.innerHTML = '<div class="error-message">×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×ª××©×™×. ×× × × ×¡×” ×©×•×‘.</div>';
                    usersResultsInfo.textContent = '';
                }
            }
            
            function renderUsers(users) {
                if (!users || users.length === 0) {
                    usersListContainer.innerHTML = '<div class="empty-message">××™×Ÿ ××©×ª××©×™× ×‘×¨×©×™××” ××• ×œ× × ××¦××• ×ª×•×¦××•×ª ×œ×—×™×¤×•×© ×©×œ×š.</div>';
                    return;
                }
                
                let html = '';
                users.forEach((user) => {
                    const statusClass = user.status === 'active' ? 'text-success' : 'text-danger';
                    const statusText = user.status === 'active' ? '×¤×¢×™×œ' : '××•×©×‘×ª';
                    
                    html += `
                        <div class="item-card" data-id="${user.id}">
                            <div class="item-actions">
                                <button class="action-button edit-button" data-id="${user.id}" title="×¢×¨×•×š">âœï¸</button>
                            </div>
                            <div class="item-title">${user.name || user.email || '×œ×œ× ×©×'}</div>
                            <div class="item-details">
                                <div>××™××™×™×œ: ${user.email}</div>
                                <div>×ª×¤×§×™×“: ${user.role === 'admin' ? '×× ×”×œ' : '××©×ª××©'}</div>
                                <div>×¡×˜×˜×•×¡: <span class="${statusClass}">${statusText}</span></div>
                                <div>×”×¦×˜×¨×£: ${formatDate(user.createdAt)}</div>
                            </div>
                        </div>
                    `;
                });
                
                usersListContainer.innerHTML = html;
            }
            
            // Function to load interest areas for a service
            async function loadInterestAreasForService(serviceId) {
                try {
                    const serviceInterestAreasContainer = document.getElementById('service-interest-areas-container');
                    serviceInterestAreasContainer.innerHTML = '<div class="spinner"></div>';
                    
                    const db = firebase.firestore();
                    
                    // Ensure interest areas are loaded first
                    if (allInterestAreas.length === 0) {
                        await loadInterestAreas();
                    }
                    
                    // Get all interest areas
                    const allInterestAreasWithState = allInterestAreas.map(area => ({
                        ...area,
                        selected: false
                    }));
                    
                    if (serviceId) {
                        // Get service-specific interest areas
                        const snapshot = await db.collection('service-interest-areas')
                            .where('serviceId', '==', serviceId)
                            .get();
                        
                        if (!snapshot.empty) {
                            const serviceInterestAreas = snapshot.docs.map(doc => doc.data());
                            
                            // Mark selected interest areas
                            serviceInterestAreas.forEach(serviceArea => {
                                const matchingArea = allInterestAreasWithState.find(area => area.id === serviceArea.interestAreaId);
                                if (matchingArea) {
                                    matchingArea.selected = true;
                                }
                            });
                        }
                    }
                    
                    // Render checkboxes for all interest areas
                    let html = '';
                    
                    if (allInterestAreasWithState.length === 0) {
                        html = '<div>××™×Ÿ ×ª×—×•××™ ×¢× ×™×™×Ÿ ×–××™× ×™×.</div>';
                    } else {
                        html = '<div class="interest-areas-list">';
                        allInterestAreasWithState.forEach(area => {
                            html += `
                                <div class="interest-area-item">
                                    <label class="checkbox-container">
                                        <input type="checkbox" 
                                            name="interest-area" 
                                            value="${area.id}" 
                                            ${area.selected ? 'checked' : ''}>
                                        <span class="checkmark"></span>
                                        ${area.name}
                                    </label>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    serviceInterestAreasContainer.innerHTML = html;
                    
                } catch (error) {
                    console.error('Error loading interest areas for service:', error);
                    document.getElementById('service-interest-areas-container').innerHTML = 
                        '<div class="error-message">×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×—×•××™ ×”×¢× ×™×™×Ÿ. ×× × × ×¡×” ×©×•×‘.</div>';
                }
            }
            
            // Set up search functionality
            document.getElementById('services-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.trim().toLowerCase();
                if (searchTerm === '') {
                    renderServices(allServices);
                    servicesResultsInfo.textContent = `${allServices.length} ×©×™×¨×•×ª×™×`;
                } else {
                    const filteredServices = allServices.filter(service => 
                        service.name?.toLowerCase().includes(searchTerm) || 
                        service.description?.toLowerCase().includes(searchTerm)
                    );
                    renderServices(filteredServices);
                    servicesResultsInfo.textContent = `${filteredServices.length} ×©×™×¨×•×ª×™× ××ª×•×š ${allServices.length}`;
                }
            });
            
            document.getElementById('categories-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.trim().toLowerCase();
                if (searchTerm === '') {
                    renderCategories(allCategories);
                    categoriesResultsInfo.textContent = `${allCategories.length} ×§×˜×’×•×¨×™×•×ª`;
                } else {
                    const filteredCategories = allCategories.filter(category => 
                        category.name?.toLowerCase().includes(searchTerm) || 
                        category.description?.toLowerCase().includes(searchTerm)
                    );
                    renderCategories(filteredCategories);
                    categoriesResultsInfo.textContent = `${filteredCategories.length} ×§×˜×’×•×¨×™×•×ª ××ª×•×š ${allCategories.length}`;
                }
            });
            
            document.getElementById('interest-areas-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.trim().toLowerCase();
                if (searchTerm === '') {
                    renderInterestAreas(allInterestAreas);
                    interestAreasResultsInfo.textContent = `${allInterestAreas.length} ×ª×—×•××™ ×¢× ×™×™×Ÿ`;
                } else {
                    const filteredInterestAreas = allInterestAreas.filter(area => 
                        area.name?.toLowerCase().includes(searchTerm) || 
                        area.description?.toLowerCase().includes(searchTerm)
                    );
                    renderInterestAreas(filteredInterestAreas);
                    interestAreasResultsInfo.textContent = `${filteredInterestAreas.length} ×ª×—×•××™ ×¢× ×™×™×Ÿ ××ª×•×š ${allInterestAreas.length}`;
                }
            });
            
            document.getElementById('users-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.trim().toLowerCase();
                if (searchTerm === '') {
                    renderUsers(allUsers);
                    usersResultsInfo.textContent = `${allUsers.length} ××©×ª××©×™×`;
                } else {
                    const filteredUsers = allUsers.filter(user => 
                        user.name?.toLowerCase().includes(searchTerm) || 
                        user.email?.toLowerCase().includes(searchTerm)
                    );
                    renderUsers(filteredUsers);
                    usersResultsInfo.textContent = `${filteredUsers.length} ××©×ª××©×™× ××ª×•×š ${allUsers.length}`;
                }
            });
            
            // Set up nav button click handling
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('.nav-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Hide all sections
                    document.querySelectorAll('.admin-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Show corresponding section
                    const targetSection = this.dataset.section;
                    document.getElementById(targetSection).classList.add('active');
                    
                    // Load data for the section if needed
                    if (targetSection === 'services-section' && allServices.length === 0) {
                        loadServices();
                    } else if (targetSection === 'categories-section' && allCategories.length === 0) {
                        loadCategories();
                    } else if (targetSection === 'interest-areas-section' && allInterestAreas.length === 0) {
                        loadInterestAreas();
                    } else if (targetSection === 'users-section' && allUsers.length === 0) {
                        loadUsers();
                    }
                });
            });
            
            // Set up refresh button
            document.getElementById('refresh-data-button').addEventListener('click', async () => {
                try {
                    loadingOverlay.style.display = 'flex';
                    // Clear all cache
                    clearCache();
                    console.log('××¨×¢× ×Ÿ ××ª ×›×œ ×”× ×ª×•× ×™×...');
                    
                    // Clear all arrays
                    allServices = [];
                    allCategories = [];
                    allInterestAreas = [];
                    allUsers = [];
                    
                    // Reload data in order of dependency
                    await loadCategories();
                    await loadInterestAreas();
                    await loadServices();
                    await loadUsers();
                    
                    loadingOverlay.style.display = 'none';
                    showMessage('×”× ×ª×•× ×™× ×¨×•×¢× × ×• ×‘×”×¦×œ×—×”', 'success');
                } catch (error) {
                    console.error('×©×’×™××” ×‘×¨×™×¢× ×•×Ÿ ×”× ×ª×•× ×™×:', error);
                    loadingOverlay.style.display = 'none';
                    showMessage('×©×’×™××” ×‘×¨×™×¢× ×•×Ÿ ×”× ×ª×•× ×™×', 'error');
                }
            });
            
            // Initial data loading
            loadCategories().then(() => {
                loadInterestAreas().then(() => {
                    loadServices().then(() => {
                        loadUsers();
                    });
                });
            });

            // Service Modal Events
            document.getElementById('add-service').addEventListener('click', function() {
                document.getElementById('service-modal-title').textContent = '×”×•×¡×¤×ª ×©×™×¨×•×ª ×—×“×©';
                document.getElementById('service-id').value = '';
                document.getElementById('service-name').value = '';
                document.getElementById('service-description').value = '';
                document.getElementById('service-category').value = '';
                
                // Load categories into dropdown
                const categorySelect = document.getElementById('service-category');
                categorySelect.innerHTML = '<option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>';
                
                allCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                // Load interest areas (all unchecked)
                loadInterestAreasForService(null);
                
                // Show modal
                document.getElementById('service-modal').style.display = 'flex';
            });
            
            document.getElementById('close-service-modal').addEventListener('click', function() {
                document.getElementById('service-modal').style.display = 'none';
            });
            
            document.getElementById('cancel-service').addEventListener('click', function() {
                document.getElementById('service-modal').style.display = 'none';
            });
            
            document.getElementById('service-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const serviceId = document.getElementById('service-id').value;
                const name = document.getElementById('service-name').value.trim();
                const description = document.getElementById('service-description').value.trim();
                const categoryId = document.getElementById('service-category').value;
                
                if (!name) {
                    document.getElementById('service-name-error').textContent = '×©×“×” ×—×•×‘×”';
                    return;
                }
                
                try {
                    loadingOverlay.style.display = 'flex';
                    
                    const db = firebase.firestore();
                    const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                    
                    // Get selected interest areas
                    const selectedInterestAreaIds = Array.from(
                        document.querySelectorAll('#service-interest-areas-container input[name="interest-area"]:checked')
                    ).map(checkbox => checkbox.value);
                    
                    if (serviceId) {
                        // Update existing service
                        await db.collection('services').doc(serviceId).update({
                            name,
                            description,
                            categoryId,
                            updatedAt: timestamp
                        });
                        
                        // Update service interest areas
                        // First delete all existing associations
                        const existingAssociations = await db.collection('service-interest-areas')
                            .where('serviceId', '==', serviceId)
                            .get();
                        
                        const batch = db.batch();
                        
                        existingAssociations.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        // Then add new ones
                        selectedInterestAreaIds.forEach(interestAreaId => {
                            const newAssocRef = db.collection('service-interest-areas').doc();
                            batch.set(newAssocRef, {
                                serviceId,
                                interestAreaId,
                                createdAt: timestamp
                            });
                        });
                        
                        await batch.commit();
                        
                        showMessage('×”×©×™×¨×•×ª ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
                    } else {
                        // Create new service
                        const serviceRef = db.collection('services').doc();
                        const newServiceId = serviceRef.id;
                        
                        await serviceRef.set({
                            name,
                            description,
                            categoryId,
                            createdAt: timestamp,
                            updatedAt: timestamp
                        });
                        
                        // Create service interest areas
                        const batch = db.batch();
                        
                        selectedInterestAreaIds.forEach(interestAreaId => {
                            const newAssocRef = db.collection('service-interest-areas').doc();
                            batch.set(newAssocRef, {
                                serviceId: newServiceId,
                                interestAreaId,
                                createdAt: timestamp
                            });
                        });
                        
                        await batch.commit();
                        
                        showMessage('×”×©×™×¨×•×ª × ×•×¦×¨ ×‘×”×¦×œ×—×”', 'success');
                    }
                    
                    // Refresh services list
                    allServices = [];
                    await loadServices();
                    
                    // Close modal
                    document.getElementById('service-modal').style.display = 'none';
                    loadingOverlay.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error saving service:', error);
                    loadingOverlay.style.display = 'none';
                    showMessage('×©×’×™××” ×‘×©××™×¨×ª ×”×©×™×¨×•×ª', 'error');
                }
            });
            
            // Handle service edit buttons (delegated event)
            document.getElementById('services-list').addEventListener('click', async function(e) {
                if (e.target.classList.contains('edit-button')) {
                    const serviceId = e.target.dataset.id;
                    const service = allServices.find(s => s.id === serviceId);
                    
                    if (!service) {
                        console.error('Service not found:', serviceId);
                        return;
                    }
                    
                    // Fill form
                    document.getElementById('service-modal-title').textContent = '×¢×¨×™×›×ª ×©×™×¨×•×ª';
                    document.getElementById('service-id').value = service.id;
                    document.getElementById('service-name').value = service.name || '';
                    document.getElementById('service-description').value = service.description || '';
                    document.getElementById('service-category').value = service.categoryId || '';
                    
                    // Load categories into dropdown
                    const categorySelect = document.getElementById('service-category');
                    categorySelect.innerHTML = '<option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>';
                    
                    allCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                    
                    // Select the right category
                    categorySelect.value = service.categoryId || '';
                    
                    // Load interest areas with correct selections
                    await loadInterestAreasForService(service.id);
                    
                    // Show modal
                    document.getElementById('service-modal').style.display = 'flex';
                }
                
                if (e.target.classList.contains('delete-button')) {
                    const serviceId = e.target.dataset.id;
                    const service = allServices.find(s => s.id === serviceId);
                    
                    if (!service) {
                        console.error('Service not found:', serviceId);
                        return;
                    }
                    
                    if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×©×™×¨×•×ª "${service.name}"?`)) {
                        try {
                            loadingOverlay.style.display = 'flex';
                            
                            const db = firebase.firestore();
                            
                            // Delete service interest areas first
                            const existingAssociations = await db.collection('service-interest-areas')
                                .where('serviceId', '==', serviceId)
                                .get();
                            
                            const batch = db.batch();
                            
                            existingAssociations.docs.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            
                            // Delete service
                            batch.delete(db.collection('services').doc(serviceId));
                            
                            await batch.commit();
                            
                            // Refresh services list
                            allServices = [];
                            await loadServices();
                            
                            loadingOverlay.style.display = 'none';
                            showMessage('×”×©×™×¨×•×ª × ××—×§ ×‘×”×¦×œ×—×”', 'success');
                            
                        } catch (error) {
                            console.error('Error deleting service:', error);
                            loadingOverlay.style.display = 'none';
                            showMessage('×©×’×™××” ×‘××—×™×§×ª ×”×©×™×¨×•×ª', 'error');
                        }
                    }
                }
            });
            
            // Category Modal Events
            document.getElementById('add-category').addEventListener('click', function() {
                document.getElementById('category-modal-title').textContent = '×”×•×¡×¤×ª ×§×˜×’×•×¨×™×” ×—×“×©×”';
                document.getElementById('category-id').value = '';
                document.getElementById('category-name').value = '';
                document.getElementById('category-description').value = '';
                
                // Show modal
                document.getElementById('category-modal').style.display = 'flex';
            });
            
            document.getElementById('close-category-modal').addEventListener('click', function() {
                document.getElementById('category-modal').style.display = 'none';
            });
            
            document.getElementById('cancel-category').addEventListener('click', function() {
                document.getElementById('category-modal').style.display = 'none';
            });
            
            document.getElementById('category-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const categoryId = document.getElementById('category-id').value;
                const name = document.getElementById('category-name').value.trim();
                const description = document.getElementById('category-description').value.trim();
                
                if (!name) {
                    document.getElementById('category-name-error').textContent = '×©×“×” ×—×•×‘×”';
                    return;
                }
                
                try {
                    loadingOverlay.style.display = 'flex';
                    
                    const db = firebase.firestore();
                    const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                    
                    if (categoryId) {
                        // Update existing category
                        await db.collection('categories').doc(categoryId).update({
                            name,
                            description,
                            updatedAt: timestamp
                        });
                        
                        showMessage('×”×§×˜×’×•×¨×™×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”', 'success');
                    } else {
                        // Create new category
                        await db.collection('categories').doc().set({
                            name,
                            description,
                            createdAt: timestamp,
                            updatedAt: timestamp
                        });
                        
                        showMessage('×”×§×˜×’×•×¨×™×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”', 'success');
                    }
                    
                    // Refresh categories list
                    allCategories = [];
                    await loadCategories();
                    
                    // Close modal
                    document.getElementById('category-modal').style.display = 'none';
                    loadingOverlay.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error saving category:', error);
                    loadingOverlay.style.display = 'none';
                    showMessage('×©×’×™××” ×‘×©××™×¨×ª ×”×§×˜×’×•×¨×™×”', 'error');
                }
            });
            
            // Handle category edit buttons (delegated event)
            document.getElementById('categories-list').addEventListener('click', async function(e) {
                if (e.target.classList.contains('edit-button')) {
                    const categoryId = e.target.dataset.id;
                    const category = allCategories.find(c => c.id === categoryId);
                    
                    if (!category) {
                        console.error('Category not found:', categoryId);
                        return;
                    }
                    
                    // Fill form
                    document.getElementById('category-modal-title').textContent = '×¢×¨×™×›×ª ×§×˜×’×•×¨×™×”';
                    document.getElementById('category-id').value = category.id;
                    document.getElementById('category-name').value = category.name || '';
                    document.getElementById('category-description').value = category.description || '';
                    
                    // Show modal
                    document.getElementById('category-modal').style.display = 'flex';
                }
                
                if (e.target.classList.contains('delete-button')) {
                    const categoryId = e.target.dataset.id;
                    const category = allCategories.find(c => c.id === categoryId);
                    
                    if (!category) {
                        console.error('Category not found:', categoryId);
                        return;
                    }
                    
                    if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×§×˜×’×•×¨×™×” "${category.name}"?`)) {
                        try {
                            loadingOverlay.style.display = 'flex';
                            
                            // Check if category is used by any services
                            const db = firebase.firestore();
                            const servicesUsingCategory = await db.collection('services')
                                .where('categoryId', '==', categoryId)
                                .limit(1)
                                .get();
                            
                            if (!servicesUsingCategory.empty) {
                                loadingOverlay.style.display = 'none';
                                alert('×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×§×˜×’×•×¨×™×” ×©××©×•×™×›×ª ×œ×©×™×¨×•×ª×™×. ×× × ×”×¡×¨ ××ª ×”×©×™×•×š ××©×™×¨×•×ª×™× ×ª×—×™×œ×”.');
                                return;
                            }
                            
                            // Delete category
                            await db.collection('categories').doc(categoryId).delete();
                            
                            // Refresh categories list
                            allCategories = [];
                            await loadCategories();
                            
                            loadingOverlay.style.display = 'none';
                            showMessage('×”×§×˜×’×•×¨×™×” × ××—×§×” ×‘×”×¦×œ×—×”', 'success');
                            
                        } catch (error) {
                            console.error('Error deleting category:', error);
                            loadingOverlay.style.display = 'none';
                            showMessage('×©×’×™××” ×‘××—×™×§×ª ×”×§×˜×’×•×¨×™×”', 'error');
                        }
                    }
                }
            });
            
            // Interest Area Modal Events
            document.getElementById('add-interest-area').addEventListener('click', function() {
                document.getElementById('interest-area-modal-title').textContent = '×”×•×¡×¤×ª ×ª×—×•× ×¢× ×™×™×Ÿ ×—×“×©';
                document.getElementById('interest-area-id').value = '';
                document.getElementById('interest-area-name').value = '';
                document.getElementById('interest-area-description').value = '';
                
                // Show modal
                document.getElementById('interest-area-modal').style.display = 'flex';
            });
            
            document.getElementById('close-interest-area-modal').addEventListener('click', function() {
                document.getElementById('interest-area-modal').style.display = 'none';
            });
            
            document.getElementById('cancel-interest-area').addEventListener('click', function() {
                document.getElementById('interest-area-modal').style.display = 'none';
            });
            
            document.getElementById('interest-area-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const interestAreaId = document.getElementById('interest-area-id').value;
                const name = document.getElementById('interest-area-name').value.trim();
                const description = document.getElementById('interest-area-description').value.trim();
                
                if (!name) {
                    document.getElementById('interest-area-name-error').textContent = '×©×“×” ×—×•×‘×”';
                    return;
                }
                
                try {
                    loadingOverlay.style.display = 'flex';
                    
                    const db = firebase.firestore();
                    const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                    
                    if (interestAreaId) {
                        // Update existing interest area
                        await db.collection('interest-areas').doc(interestAreaId).update({
                            name,
                            description,
                            updatedAt: timestamp
                        });
                        
                        showMessage('×ª×—×•× ×”×¢× ×™×™×Ÿ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
                    } else {
                        // Create new interest area
                        await db.collection('interest-areas').doc().set({
                            name,
                            description,
                            createdAt: timestamp,
                            updatedAt: timestamp
                        });
                        
                        showMessage('×ª×—×•× ×”×¢× ×™×™×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”', 'success');
                    }
                    
                    // Refresh interest areas list
                    allInterestAreas = [];
                    await loadInterestAreas();
                    
                    // Close modal
                    document.getElementById('interest-area-modal').style.display = 'none';
                    loadingOverlay.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error saving interest area:', error);
                    loadingOverlay.style.display = 'none';
                    showMessage('×©×’×™××” ×‘×©××™×¨×ª ×ª×—×•× ×”×¢× ×™×™×Ÿ', 'error');
                }
            });
            
            // Handle interest area edit buttons (delegated event)
            document.getElementById('interest-areas-list').addEventListener('click', async function(e) {
                if (e.target.classList.contains('edit-button')) {
                    const interestAreaId = e.target.dataset.id;
                    const interestArea = allInterestAreas.find(a => a.id === interestAreaId);
                    
                    if (!interestArea) {
                        console.error('Interest area not found:', interestAreaId);
                        return;
                    }
                    
                    // Fill form
                    document.getElementById('interest-area-modal-title').textContent = '×¢×¨×™×›×ª ×ª×—×•× ×¢× ×™×™×Ÿ';
                    document.getElementById('interest-area-id').value = interestArea.id;
                    document.getElementById('interest-area-name').value = interestArea.name || '';
                    document.getElementById('interest-area-description').value = interestArea.description || '';
                    
                    // Show modal
                    document.getElementById('interest-area-modal').style.display = 'flex';
                }
                
                if (e.target.classList.contains('delete-button')) {
                    const interestAreaId = e.target.dataset.id;
                    const interestArea = allInterestAreas.find(a => a.id === interestAreaId);
                    
                    if (!interestArea) {
                        console.error('Interest area not found:', interestAreaId);
                        return;
                    }
                    
                    if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×ª×—×•× ×”×¢× ×™×™×Ÿ "${interestArea.name}"?`)) {
                        try {
                            loadingOverlay.style.display = 'flex';
                            
                            // Check if interest area is used by any services
                            const db = firebase.firestore();
                            const servicesUsingInterestArea = await db.collection('service-interest-areas')
                                .where('interestAreaId', '==', interestAreaId)
                                .limit(1)
                                .get();
                            
                            if (!servicesUsingInterestArea.empty) {
                                loadingOverlay.style.display = 'none';
                                alert('×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×ª×—×•× ×¢× ×™×™×Ÿ ×©××©×•×™×š ×œ×©×™×¨×•×ª×™×. ×× × ×”×¡×¨ ××ª ×”×©×™×•×š ××©×™×¨×•×ª×™× ×ª×—×™×œ×”.');
                                return;
                            }
                            
                            // Delete interest area
                            await db.collection('interest-areas').doc(interestAreaId).delete();
                            
                            // Refresh interest areas list
                            allInterestAreas = [];
                            await loadInterestAreas();
                            
                            loadingOverlay.style.display = 'none';
                            showMessage('×ª×—×•× ×”×¢× ×™×™×Ÿ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
                            
                        } catch (error) {
                            console.error('Error deleting interest area:', error);
                            loadingOverlay.style.display = 'none';
                            showMessage('×©×’×™××” ×‘××—×™×§×ª ×ª×—×•× ×”×¢× ×™×™×Ÿ', 'error');
                        }
                    }
                }
            });
            
            // User Modal Events
            document.getElementById('users-list').addEventListener('click', async function(e) {
                if (e.target.classList.contains('edit-button')) {
                    const userId = e.target.dataset.id;
                    const user = allUsers.find(u => u.id === userId);
                    
                    if (!user) {
                        console.error('User not found:', userId);
                        return;
                    }
                    
                    // Fill form
                    document.getElementById('user-modal-title').textContent = '×¢×¨×™×›×ª ××©×ª××©';
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('user-name').value = user.name || '';
                    document.getElementById('user-email').value = user.email || '';
                    document.getElementById('user-role').value = user.role || 'user';
                    document.getElementById('user-status').checked = user.status === 'active';
                    document.getElementById('status-text').textContent = user.status === 'active' ? '×¤×¢×™×œ' : '××•×©×‘×ª';
                    
                    // Show modal
                    document.getElementById('user-modal').style.display = 'flex';
                }
            });
            
            document.getElementById('close-user-modal').addEventListener('click', function() {
                document.getElementById('user-modal').style.display = 'none';
            });
            
            document.getElementById('cancel-user').addEventListener('click', function() {
                document.getElementById('user-modal').style.display = 'none';
            });
            
            document.getElementById('user-status').addEventListener('change', function() {
                document.getElementById('status-text').textContent = this.checked ? '×¤×¢×™×œ' : '××•×©×‘×ª';
            });
            
            document.getElementById('user-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const userId = document.getElementById('user-id').value;
                const name = document.getElementById('user-name').value.trim();
                const role = document.getElementById('user-role').value;
                const status = document.getElementById('user-status').checked ? 'active' : 'inactive';
                
                if (!userId) {
                    console.error('User ID is missing');
                    return;
                }
                
                try {
                    loadingOverlay.style.display = 'flex';
                    
                    const db = firebase.firestore();
                    const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                    
                    // Update user
                    await db.collection('users').doc(userId).update({
                        name,
                        role,
                        status,
                        updatedAt: timestamp
                    });
                    
                    showMessage('×”××©×ª××© ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
                    
                    // Refresh users list
                    allUsers = [];
                    await loadUsers();
                    
                    // Close modal
                    document.getElementById('user-modal').style.display = 'none';
                    loadingOverlay.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error updating user:', error);
                    loadingOverlay.style.display = 'none';
                    showMessage('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”××©×ª××©', 'error');
                }
            });
        }
        
        // Start initialization
        init();
    </script>
</body>
</html> 